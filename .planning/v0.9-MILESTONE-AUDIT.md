# v0.9 Security Hardening Milestone Audit Report

**Audit Date:** 2026-01-21  
**Auditor:** Claude Code Analysis  
**Scope:** Requirements in `.planning/REQUIREMENTS.md` vs actual implementation  
**Milestone Status:** INCOMPLETE - Critical gaps found

---

## Executive Summary

The v0.9 Security Hardening milestone is **incomplete**. While Phase 9 (Key Foundation) has been implemented with partial integration, **Phase 10 (Storage Encryption) and Phase 11 (Cross-Tab Security) have not been implemented at all**. 

**Critical Finding:** API keys and chat history are currently stored **unencrypted** in IndexedDB, violating requirements STORE-01 through STORE-04. BroadcastChannel messages lack HMAC signatures, violating requirements XTAB-01 through XTAB-06.

**Overall Completion:** 8/23 requirements satisfied (35%)

---

## Requirements Satisfaction Status

### Phase 9: Key Foundation (8/8 requirements)

| ID | Requirement | Status | Evidence | Location |
|----|-------------|--------|----------|----------|
| KEY-01 | Non-extractable CryptoKey objects | ✓ SATISFIED | All 6 derivation points use `extractable: false` | `/js/security/key-manager.js:202,216,240,254,278,292` |
| KEY-02 | PBKDF2 with 600,000 iterations | ✓ SATISFIED | All implementations exceed 100k requirement | `/js/security/key-manager.js:211,249,287` |
| KEY-03 | New session keys per browser session | ✓ SATISFIED | `initializeSession()` generates unique salt; called in main.js | `/js/security/key-manager.js:38-67`, `/js/main.js:454` |
| KEY-04 | Raw key material never persisted | ✓ SATISFIED | Keys stored only in memory as non-extractable objects | `/js/security/key-manager.js:14-21` |
| KEY-05 | Session keys cleared on logout | ✓ SATISFIED | `clearSession()` called via settings.js logout | `/js/settings.js:1570` |
| INFRA-01 | Secure context validation | ✓ SATISFIED | `isSecureContext()` checks HTTPS, localhost, 127.0.0.1 | `/js/security/key-manager.js:132-155` |
| INFRA-02 | KeyManager module exists | ✓ SATISFIED | 297-line module with complete lifecycle management | `/js/security/key-manager.js` |
| INFRA-05 | Crypto errors don't leak details | ✓ SATISFIED | Generic error messages throughout | `/js/security/key-manager.js:65,79,89,103` |

**Phase 9 Status:** COMPLETE (with integration gaps noted below)

---

### Phase 10: Storage Encryption (0/9 requirements)

| ID | Requirement | Status | Evidence |
|----|-------------|--------|----------|
| STORE-01 | OpenRouter API keys encrypted | ✗ NOT IMPLEMENTED | No encryption layer in config-api.js |
| STORE-02 | Gemini API keys encrypted | ✗ NOT IMPLEMENTED | No encryption layer in config-api.js |
| STORE-03 | All LLM provider API keys encrypted | ✗ NOT IMPLEMENTED | API keys stored plaintext in CONFIG store |
| STORE-04 | Chat history encrypted | ✗ NOT IMPLEMENTED | Chat sessions stored plaintext in CHAT_SESSIONS store |
| STORE-05 | Unique IV per encryption | ✗ NOT IMPLEMENTED | No encryption operations exist |
| STORE-06 | IV stored with ciphertext | ✗ NOT IMPLEMENTED | No encryption operations exist |
| STORE-07 | Key rotation support | ✗ NOT IMPLEMENTED | No storage-encryption.js module exists |
| STORE-08 | Secure data deletion | ✗ NOT IMPLEMENTED | No overwrite-before-delete logic |
| INFRA-04 | StorageEncryption module | ✗ NOT IMPLEMENTED | File does not exist at `/js/security/storage-encryption.js` |

**Phase 10 Status:** NOT STARTED

**Evidence of Unencrypted Storage:**
- `/js/storage/config-api.js:58-81` - `setConfig()` stores values directly without encryption
- `/js/storage/config-api.js:22-50` - `getConfig()` retrieves values directly without decryption
- `/js/storage/indexeddb.js:320-323` - CONFIG and TOKENS stores created with no encryption wrapper
- API keys (OpenRouter, Gemini) stored via `Storage.setConfig()` go directly to IndexedDB as plaintext

---

### Phase 11: Cross-Tab Security (0/7 requirements)

| ID | Requirement | Status | Evidence |
|----|-------------|--------|----------|
| XTAB-01 | Messages include HMAC signature | ✗ NOT IMPLEMENTED | BroadcastChannel messages have no signature field |
| XTAB-02 | HMAC verification on receive | ✗ NOT IMPLEMENTED | No verification logic in message handler |
| XTAB-03 | Origin validation | ✗ NOT IMPLEMENTED | No origin check in message handler |
| XTAB-04 | Sensitive data sanitized | ✗ NOT IMPLEMENTED | API keys/tokens broadcast in plaintext |
| XTAB-05 | Timestamp for replay prevention | ✗ NOT IMPLEMENTED | Only vectorClock, no anti-replay timestamp |
| XTAB-06 | Reject messages older than 5s | ✗ NOT IMPLEMENTED | No timestamp validation logic |
| INFRA-03 | MessageSecurity module | ✗ NOT IMPLEMENTED | File does not exist at `/js/security/message-security.js` |

**Phase 11 Status:** NOT STARTED

**Evidence of Unsecured Cross-Tab Communication:**
- `/js/services/tab-coordination.js:463-466` - `postMessage()` sends plain objects
- `/js/services/tab-coordination.js:478-483` - CANDIDATE message has no signature
- `/js/services/tab-coordination.js:931-941` - HEARTBEAT message has no signature
- `/js/services/tab-coordination.js:637-699` - `createMessageHandler()` has no verification logic
- Messages include `vectorClock` and `senderId` but no HMAC or timestamp for replay protection

---

## Integration Gaps Found

### 1. KeyManager Integration Gap (Phase 9)

**Issue:** KeyManager is initialized but specialized keys are not accessible through Security facade.

**Impact:** Other security modules cannot access data encryption keys or signing keys needed for Phases 10 & 11.

**Evidence:**
- `/js/security/index.js:345-349` - Only exports 4 KeyManager methods:
  - ✓ `initializeKeySession: KeyManager.initializeSession`
  - ✓ `clearKeySession: KeyManager.clearSession`
  - ✓ `isSecureContextKeyManager: KeyManager.isSecureContext`
  - ✓ `isKeySessionActive: KeyManager.isSessionActive`
- Missing exports:
  - ✗ `getDataEncryptionKey` → Required for STORE-01 through STORE-08
  - ✗ `getSigningKey` → Required for XTAB-01 and XTAB-02
  - ✗ `getSessionKey` → Conflicts with Encryption.getSessionKey

**Facade Confusion:**
- `/js/security/index.js:290` - Exports `Encryption.getSessionKey` (old implementation)
- `/js/security/key-manager.js:75-80` - Has `KeyManager.getSessionKey()` (new implementation)
- Unclear which one modules should use

---

### 2. Storage Layer Not Wired for Encryption (Phase 10)

**Issue:** ConfigAPI and IndexedDBCore have no encryption integration points.

**Impact:** Even if StorageEncryption module existed, there's no place to inject it.

**Required Changes:**
1. `/js/storage/config-api.js` - Needs `shouldEncrypt()` check before `setConfig()`
2. `/js/storage/indexeddb.js` - Needs wrapper around `put()` and `get()` for CONFIG store
3. `/js/storage/config-api.js` - Needs `encryptValue()` and `decryptValue()` functions
4. Migration path for existing plaintext API keys in IndexedDB

---

### 3. Message Signing Not Integrated (Phase 11)

**Issue:** TabCoordination has no injection point for message signing.

**Impact:** Even if MessageSecurity module existed, it can't be used without transport layer changes.

**Required Changes:**
1. `/js/services/tab-coordination.js:625-632` - `sendMessage()` needs `signMessage()` call
2. `/js/services/tab-coordination.js:637-699` - `createMessageHandler()` needs `verifyMessage()` call
3. `/js/services/tab-coordination.js:463-466` - Transport interface needs signature field
4. Add nonce tracking for replay attack prevention

---

## End-to-End Flow Issues

### Flow 1: API Key Storage (BROKEN)

**Expected Flow (per Phase 10 plan):**
1. User enters API key in Settings
2. Settings calls `Storage.setConfig('openrouter_api_key', key)`
3. ConfigAPI checks `shouldEncrypt('openrouter_api_key')` → true
4. ConfigAPI calls `KeyManager.getDataEncryptionKey()`
5. ConfigAPI calls `encryptData(key, dataEncryptionKey)`
6. ConfigAPI stores `{key, ciphertext, iv}` in IndexedDB

**Actual Flow:**
1. User enters API key in Settings
2. Settings calls `Storage.setConfig('openrouter_api_key', key)`
3. ConfigAPI stores `{key, value: key}` **as plaintext** in IndexedDB ❌

**Broken Steps:**
- Step 3: No `shouldEncrypt()` check exists
- Step 4: `KeyManager.getDataEncryptionKey()` not exported through Security facade
- Step 5: No `encryptData()` wrapper for config values
- Step 6: No encryption happens

---

### Flow 2: Cross-Tab Message (BROKEN)

**Expected Flow (per Phase 11 plan):**
1. Primary tab sends heartbeat via `sendMessage()`
2. TabCoordination calls `MessageSecurity.signMessage(message)`
3. MessageSecurity calls `KeyManager.getSigningKey()`
4. MessageSecurity generates HMAC-SHA256 signature
5. TabCoordination broadcasts `{message, signature, timestamp}`
6. Receiving tab validates timestamp (< 5s old)
7. Receiving tab calls `MessageSecurity.verifyMessage(message, signature)`
8. MessageSecurity checks HMAC matches

**Actual Flow:**
1. Primary tab sends heartbeat via `sendMessage()`
2. TabCoordination broadcasts `{type, tabId, timestamp, vectorClock}` **with no signature** ❌

**Broken Steps:**
- Step 2: No MessageSecurity module exists
- Step 3: `KeyManager.getSigningKey()` not exported through Security facade
- Step 4: No signature generation
- Step 5: Messages sent without signature field
- Step 6: No timestamp validation (only vectorClock merge)
- Step 7: No verification logic in message handler
- Step 8: No HMAC verification

---

### Flow 3: Session Key Initialization (PARTIAL)

**Expected Flow (per Phase 9 plan):**
1. App bootstraps in main.js
2. Main calls `Security.initializeKeySession(password)`
3. KeyManager generates unique session salt
4. KeyManager derives 3 keys: session, data encryption, signing
5. Keys stored in memory as non-extractable CryptoKey objects
6. Other modules access keys via Security facade

**Actual Flow:**
1. ✓ App bootstraps in main.js
2. ✓ Main calls `Security.initializeKeySession(password)` at line 454
3. ✓ KeyManager generates unique session salt
4. ✓ KeyManager derives 3 keys successfully
5. ✓ Keys stored in memory as non-extractable CryptoKey objects
6. ❌ Other modules **cannot access** data encryption or signing keys through Security facade

**Working Steps:** 1-5 (Phase 9 core)
**Broken Step:** 6 (Integration incomplete)

---

## Prioritized Recommendations

### CRITICAL (Block v1.0 Launch)

1. **Complete KeyManager Integration in Security Facade**
   - Add to `/js/security/index.js`:
     ```javascript
     getDataEncryptionKey: KeyManager.getDataEncryptionKey,
     getSigningKey: KeyManager.getSigningKey,
     getSessionKeyKM: KeyManager.getSessionKey  // Distinguish from Encryption.getSessionKey
     ```
   - Document which getSessionKey should be used
   - Update all callers to use correct implementation

2. **Implement StorageEncryption Module** (Phase 10)
   - Create `/js/security/storage-encryption.js`
   - Implement `shouldEncrypt(key, value)` for data classification
   - Implement `encryptData(data, key)` with AES-GCM-256
   - Implement `decryptData(encryptedData, key)` with IV extraction
   - Implement unique IV generation per encryption (STORE-05)
   - Implement IV storage alongside ciphertext (STORE-06)
   - Implement `migrateData(oldKey, newKey)` for key rotation (STORE-07)
   - Implement `secureDelete(storeName, key)` for overwrite (STORE-08)

3. **Integrate Encryption into ConfigAPI** (Phase 10)
   - Modify `/js/storage/config-api.js`:
     - Add `shouldEncrypt()` check in `setConfig()`
     - Add `encryptValue()` wrapper for sensitive data
     - Add `decryptValue()` wrapper in `getConfig()`
     - Migrate existing plaintext API keys to encrypted format

4. **Implement MessageSecurity Module** (Phase 11)
   - Create `/js/security/message-security.js`
   - Implement `signMessage(message)` using HMAC-SHA256
   - Implement `verifyMessage(message, signature)` using HMAC-SHA256
   - Implement `sanitizeMessage(message)` to remove sensitive data
   - Implement `validateTimestamp(message)` with 5-second window
   - Implement nonce tracking for replay attack prevention

5. **Integrate Message Signing into TabCoordination** (Phase 11)
   - Modify `/js/services/tab-coordination.js`:
     - Add `signMessage()` call in `sendMessage()`
     - Add `verifyMessage()` call in `createMessageHandler()`
     - Add origin validation for all received messages
     - Add timestamp validation with 5-second window
     - Add nonce tracking to prevent replay attacks

### HIGH (Security Hardening)

6. **Add Key Rotation Support** (Future requirement KEY-R1)
   - Implement manual key rotation trigger
   - Implement automated re-encryption of all encrypted data
   - Add version tracking for encrypted data
   - Support multiple key versions during transition

7. **Add Secure Deletion** (STORE-08)
   - Implement overwrite-before-delete for all encrypted data
   - Use random data overwrite (3-pass minimum)
   - Apply to both IndexedDB and localStorage fallback

### MEDIUM (Maintainability)

8. **Resolve Facade Confusion**
   - Decide: Use KeyManager.getSessionKey or Encryption.getSessionKey?
   - Document decision and deprecate unused path
   - Update all callers throughout codebase

9. **Add Integration Tests**
   - Test KeyManager initialization and cleanup
   - Test encryption/decryption round-trip
   - Test message signing and verification
   - Test cross-tab message validation

10. **Add Security Audit Logging**
    - Log all key operations (initialize, clear, rotate)
    - Log all encryption operations
    - Log all message signature failures
    - Store logs in separate, tamper-evident store

---

## Risk Assessment

### CRITICAL RISKS

1. **API Keys Stored Unencrypted** (High Impact, High Likelihood)
   - Impact: API keys exposed in browser DevTools, IndexedDB export
   - Likelihood: Certain - confirmed via code inspection
   - Affected Requirements: STORE-01, STORE-02, STORE-03
   - Mitigation: Implement Phase 10 storage encryption

2. **Chat History Stored Unencrypted** (High Impact, High Likelihood)
   - Impact: User conversations exposed in IndexedDB
   - Likelihood: Certain - confirmed via code inspection
   - Affected Requirements: STORE-04
   - Mitigation: Implement Phase 10 storage encryption

3. **Cross-Tab Messages Unsigned** (High Impact, Medium Likelihood)
   - Impact: Malicious tab can impersonate primary, inject messages
   - Likelihood: Medium - requires attacker to open malicious tab
   - Affected Requirements: XTAB-01, XTAB-02, XTAB-03
   - Mitigation: Implement Phase 11 message signing

### HIGH RISKS

4. **No Replay Attack Protection** (High Impact, Medium Likelihood)
   - Impact: Attacker can replay old messages to cause state inconsistency
   - Likelihood: Medium - requires message capture and replay
   - Affected Requirements: XTAB-05, XTAB-06
   - Mitigation: Implement timestamp validation and nonce tracking

5. **KeyManager Keys Inaccessible** (Medium Impact, High Likelihood)
   - Impact: Cannot implement Phases 10 & 11 without facade changes
   - Likelihood: Certain - confirmed via code inspection
   - Affected Requirements: STORE-01 through XTAB-06
   - Mitigation: Complete KeyManager integration in Security facade

### MEDIUM RISKS

6. **No Secure Deletion** (Medium Impact, Low Likelihood)
   - Impact: Deleted data may be recoverable from disk
   - Likelihood: Low - requires disk forensics
   - Affected Requirements: STORE-08
   - Mitigation: Implement overwrite-before-delete

7. **No Key Rotation Support** (Medium Impact, Low Likelihood)
   - Impact: Cannot rotate keys if compromised
   - Likelihood: Low - keys are non-extractable, low compromise risk
   - Affected Requirements: STORE-07
   - Mitigation: Implement key rotation (deferred to post-v1.0)

---

## Conclusion

The v0.9 Security Hardening milestone is **incomplete**. Phase 9 (Key Foundation) has been implemented with partial integration gaps, but **Phase 10 (Storage Encryption) and Phase 11 (Cross-Tab Security) have not been started**.

**Blocking Issues for v1.0 Launch:**
1. API keys and chat history stored unencrypted (STORE-01 through STORE-04)
2. Cross-tab messages lack signature verification (XTAB-01 through XTAB-06)
3. KeyManager specialized keys inaccessible through Security facade

**Recommendation:** Do not launch v1.0 until:
1. Phase 10 is implemented (storage encryption for API keys and chat history)
2. Phase 11 is implemented (message signing and verification)
3. KeyManager integration is completed in Security facade

**Estimated Effort:**
- Complete KeyManager integration: 2-4 hours
- Implement Phase 10 (StorageEncryption + ConfigAPI integration): 16-24 hours
- Implement Phase 11 (MessageSecurity + TabCoordination integration): 12-16 hours
- Testing and validation: 8-12 hours
- **Total: 38-56 hours**

---

**Audit Completed:** 2026-01-21  
**Next Review:** After Phase 10 and Phase 11 implementation  
**Auditor:** Claude Code Analysis System
