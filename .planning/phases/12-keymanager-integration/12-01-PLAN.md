---
phase: 12-keymanager-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/security/index.js
  - js/rag.js
  - WINDOW_GLOBALS_MIGRATION_GUIDE.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Security facade exports getDataEncryptionKey for storage encryption"
    - "Security facade exports getSigningKey for message signing"
    - "getSessionKey naming conflict is resolved and documented"
    - "All callers updated to use correct key access methods"
    - "KeyManager keys are accessible to other security modules"
  artifacts:
    - path: "js/security/index.js"
      provides: "Security facade with KeyManager key exports"
      contains: "getDataEncryptionKey, getSigningKey, getSessionKeyKM"
      exports: ["getDataEncryptionKey", "getSigningKey", "getSessionKeyKM"]
    - path: "js/security/key-manager.js"
      provides: "KeyManager with three key types"
      contains: "getSessionKey, getDataEncryptionKey, getSigningKey"
      exports: ["getSessionKey", "getDataEncryptionKey", "getSigningKey"]
  key_links:
    - from: "js/security/index.js"
      to: "js/security/key-manager.js"
      via: "module import and export"
      pattern: "getDataEncryptionKey.*KeyManager\\.getDataEncryptionKey|getSigningKey.*KeyManager\\.getSigningKey|getSessionKeyKM.*KeyManager\\.getSessionKey"
    - from: "js/rag.js"
      to: "js/security/index.js"
      via: "Security.getSessionKey calls"
      pattern: "Security\\.getSessionKey\\(\\)"
    - from: "WINDOW_GLOBALS_MIGRATION_GUIDE.md"
      to: "js/security/index.js"
      via: "documentation of facade exports"
      pattern: "getDataEncryptionKey|getSigningKey|getSessionKeyKM"
---

<objective>
Complete KeyManager integration in Security facade to enable Phases 13-14 (Storage Encryption and Cross-Tab Security implementation).

Purpose: Close Integration Gap #1 from v0.9-MILESTONE-AUDIT.md by exposing KeyManager's specialized keys through the Security facade. Currently, KeyManager creates data encryption and signing keys but doesn't export them, blocking other security modules from accessing keys needed for storage/message encryption.

Output: Security facade exports getDataEncryptionKey and getSigningKey, getSessionKey naming conflict resolved, all callers updated to use correct key access methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/v0.9-MILESTONE-AUDIT.md

@js/security/index.js
@js/security/key-manager.js
@js/security/encryption.js
@js/rag.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export KeyManager methods from Security facade</name>
  <files>js/security/index.js</files>
  <action>
    Add three new exports to the Security object (around line 290-350, near existing KeyManager exports):

    1. Add `getDataEncryptionKey: KeyManager.getDataEncryptionKey,` after line 349
       - This enables storage encryption (Phases 10/13)
       - Returns non-extractable AES-GCM-256 key for encrypting API keys and chat history

    2. Add `getSigningKey: KeyManager.getSigningKey,` after getDataEncryptionKey
       - This enables message signing (Phases 11/14)
       - Returns non-extractable HMAC-SHA-256 key for BroadcastChannel signatures

    3. Add `getSessionKeyKM: KeyManager.getSessionKey,` after getSigningKey
       - Resolves naming conflict with Encryption.getSessionKey
       - "KM" suffix indicates KeyManager implementation
       - Returns KeyManager's session key (not Encryption's implementation)

    DO NOT remove the existing `getSessionKey: Encryption.getSessionKey,` export at line 290.
    This maintains backward compatibility for existing callers (rag.js).

    Reference existing pattern at lines 346-349 where KeyManager methods are already exported:
    ```javascript
    KeyManager,
    initializeKeySession: KeyManager.initializeSession,
    clearKeySession: KeyManager.clearSession,
    isSecureContextKeyManager: KeyManager.isSecureContext,
    isKeySessionActive: KeyManager.isSessionActive
    ```
  </action>
  <verify>
    Check that js/security/index.js exports the three methods:
    grep -n "getDataEncryptionKey.*KeyManager" js/security/index.js
    grep -n "getSigningKey.*KeyManager" js/security/index.js
    grep -n "getSessionKeyKM.*KeyManager" js/security/index.js

    Confirm all three are in the Security object and accessible via Security.getDataEncryptionKey(), Security.getSigningKey(), and Security.getSessionKeyKM()
  </verify>
  <done>
    Security facade exports getDataEncryptionKey, getSigningKey, and getSessionKeyKM (KeyManager implementation)
  </done>
</task>

<task type="auto">
  <name>Task 2: Document getSessionKey naming resolution</name>
  <files>js/security/index.js</files>
  <action>
    Add a JSDoc comment block BEFORE the KeyManager exports section (around line 344) to document the two getSessionKey implementations:

    ```javascript
    /**
     * KeyManager Exports
     *
     * KeyManager provides three types of non-extractable keys:
     * - Session key (via getSessionKeyKM): For general crypto operations
     * - Data encryption key (via getDataEncryptionKey): For storage encryption (API keys, chat history)
     * - Signing key (via getSigningKey): For HMAC message signing (cross-tab communication)
     *
     * IMPORTANT: Two getSessionKey implementations exist:
     * 1. Security.getSessionKey → Encryption.getSessionKey (legacy, used by rag.js)
     * 2. Security.getSessionKeyKM → KeyManager.getSessionKey (new, non-extractable)
     *
     * Migration Path:
     * - Use getSessionKeyKM for new code requiring KeyManager's non-extractable session key
     * - Existing callers (rag.js) continue using getSessionKey for backward compatibility
     * - Future: Deprecate Encryption.getSessionKey after all callers migrated to KeyManager
     */
    ```

    This clarifies:
    - Which getSessionKey to use for new code (getSessionKeyKM)
    - Why both exist (backward compatibility)
    - When to use each implementation
    - Migration path for future cleanup
  </action>
  <verify>
    Check that js/security/index.js has the JSDoc comment block:
    grep -A 15 "KeyManager Exports" js/security/index.js

    Confirm documentation explains both implementations and migration path
  </verify>
  <done>
    getSessionKey naming conflict documented with clear guidance on which implementation to use
  </done>
</task>

<task type="auto">
  <name>Task 3: Update migration guide documentation</name>
  <files>WINDOW_GLOBALS_MIGRATION_GUIDE.md</files>
  <action>
    Update WINDOW_GLOBALS_MIGRATION_GUIDE.md to reflect the new KeyManager exports. Find all references to Security.getSessionKey and add guidance about the two implementations:

    1. Search for all occurrences of "Security.getSessionKey" in the file
    2. After each occurrence, add a comment: "(legacy Encryption.getSessionKey - use getSessionKeyKM for KeyManager implementation)"
    3. Add a new section at the end of the document:

    ```markdown
    ## Security Facade Key Exports

    ### KeyManager Keys (Phase 12+)

    For storage encryption and message signing, use KeyManager's non-extractable keys:

    ```javascript
    // Data encryption key (for storage encryption)
    const dataKey = await Security.getDataEncryptionKey();

    // Signing key (for message signing)
    const signingKey = await Security.getSigningKey();

    // KeyManager session key (non-extractable)
    const sessionKey = await Security.getSessionKeyKM();
    ```

    ### Legacy getSessionKey (Pre-Phase 12)

    The legacy `Security.getSessionKey` uses Encryption.getSessionKey (extractable key material):
    ```javascript
    // Old implementation - still works for backward compatibility
    const sessionKey = await Security.getSessionKey();
    ```

    **Migration:** Use `getSessionKeyKM` for new code requiring non-extractable keys.
    ```
  </action>
  <verify>
    Check that WINDOW_GLOBALS_MIGRATION_GUIDE.md has been updated:
    grep -n "getSessionKeyKM" WINDOW_GLOBALS_MIGRATION_GUIDE.md
    grep -n "Data encryption key" WINDOW_GLOBALS_MIGRATION_GUIDE.md

    Confirm all Security.getSessionKey references have migration guidance
  </verify>
  <done>
    Migration guide documents new KeyManager exports and getSessionKey resolution
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify existing callers still work</name>
  <files>js/rag.js</files>
  <action>
    Verify that existing callers of Security.getSessionKey still work correctly. The existing implementation (Encryption.getSessionKey at line 290 of js/security/index.js) remains unchanged, ensuring backward compatibility.

    1. Read js/rag.js to understand how getSessionKey is used (lines 310, 331, 363)
    2. Confirm these calls will continue to work because:
       - Security.getSessionKey still points to Encryption.getSessionKey
       - Encryption.getSessionKey implementation unchanged
       - No breaking changes to existing API

    3. Document in a comment in js/rag.js (near first usage, around line 310):
       ```javascript
       // Note: Uses Security.getSessionKey (legacy Encryption.getSessionKey)
       // For new code, use Security.getSessionKeyKM for KeyManager's non-extractable key
       ```

    DO NOT modify the actual getSessionKey calls in rag.js - they should continue working.
  </action>
  <verify>
    Check that js/rag.js still has the same getSessionKey calls:
    grep -n "Security.getSessionKey" js/rag.js

    Confirm no changes to actual calls, only added documentation comment
  </verify>
  <done>
    Existing callers (rag.js) verified to work with legacy getSessionKey implementation
  </done>
</task>

</tasks>

<verification>
Overall phase completion checks:

1. **Facade Exports Complete:**
   - Security.getDataEncryptionKey() accessible and returns KeyManager's data encryption key
   - Security.getSigningKey() accessible and returns KeyManager's signing key
   - Security.getSessionKeyKM() accessible and returns KeyManager's session key
   - All three exports documented in js/security/index.js

2. **Naming Conflict Resolved:**
   - JSDoc comment explains both getSessionKey implementations
   - Migration guide updated with KeyManager exports section
   - Clear guidance on which implementation to use for new code

3. **Backward Compatibility Maintained:**
   - Existing Security.getSessionKey still works (points to Encryption.getSessionKey)
   - rag.js calls unchanged and functional
   - No breaking changes to existing API

4. **Documentation Updated:**
   - WINDOW_GLOBALS_MIGRATION_GUIDE.md has new KeyManager exports section
   - Migration path documented for future cleanup
   - All callers have context on which implementation to use
</verification>

<success_criteria>
1. Security facade exports getDataEncryptionKey, getSigningKey, and getSessionKeyKM
2. JSDoc documentation in js/security/index.js explains getSessionKey naming resolution
3. WINDOW_GLOBALS_MIGRATION_GUIDE.md has new KeyManager exports section with examples
4. Existing callers (rag.js) still work with legacy getSessionKey implementation
5. No breaking changes to existing Security API
6. KeyManager keys are now accessible to other security modules for Phases 13-14
</success_criteria>

<output>
After completion, create `.planning/phases/12-keymanager-integration/12-01-SUMMARY.md`
</output>