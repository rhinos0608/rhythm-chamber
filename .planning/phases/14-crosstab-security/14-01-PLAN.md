---
phase: 14-crosstab-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/security/message-security.js
  - js/security/index.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "MessageSecurity module can sign messages using HMAC-SHA256"
    - "MessageSecurity module can verify HMAC-SHA256 signatures"
    - "MessageSecurity module validates message timestamps"
    - "MessageSecurity module sanitizes sensitive data from messages"
    - "MessageSecurity module tracks nonces for replay prevention"
    - "Signing uses non-extractable key from KeyManager"
  artifacts:
    - path: "js/security/message-security.js"
      provides: "HMAC-SHA256 message signing and verification"
      min_lines: 200
      contains: ["signMessage(", "verifyMessage(", "validateTimestamp(", "sanitizeMessage(", "isNonceUsed(", "markNonceUsed("]
      exports: ["MessageSecurity"]
    - path: "js/security/index.js"
      provides: "Security facade export for MessageSecurity"
      contains: "MessageSecurity"
  key_links:
    - from: "MessageSecurity.signMessage()"
      to: "crypto.subtle.sign"
      via: "Web Crypto API"
      pattern: "crypto\\.subtle\\.sign.*HMAC"
    - from: "MessageSecurity.signMessage()"
      to: "Security.getSigningKey"
      via: "KeyManager integration"
      pattern: "getSigningKey"
    - from: "MessageSecurity.verifyMessage()"
      to: "crypto.subtle.verify"
      via: "Web Crypto API"
      pattern: "crypto\\.subtle\\.verify.*HMAC"
    - from: "js/security/index.js"
      to: "js/security/message-security.js"
      via: "module import and export"
      pattern: "import.*MessageSecurity.*from.*message-security"
---

# Phase 14 Plan 01: Create MessageSecurity Module

**Objective:** Create a MessageSecurity module that provides HMAC-SHA256 message signing, signature verification, timestamp validation, sensitive data sanitization, and nonce tracking for replay attack prevention, establishing the foundation for securing BroadcastChannel communications.

Purpose: Implement the core cryptographic operations needed to authenticate and validate cross-tab messages, prevent message spoofing and replay attacks, and protect sensitive data from being broadcasted.
Output: MessageSecurity module with sign/verify/timestamp/sanitize/nonce methods integrated into Security facade.

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Prior Phase Summaries
@.planning/phases/12-keymanager-integration/12-01-SUMMARY.md
@.planning/phases/09-key-foundation/09-01-SUMMARY.md
@.planning/phases/13-storage-encryption/13-01-SUMMARY.md

# Existing Security Infrastructure
@js/security/key-manager.js
@js/security/encryption.js
@js/security/index.js
@js/security/storage-encryption.js

# Target Integration Point
@js/services/tab-coordination.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessageSecurity module with HMAC-SHA256 operations</name>
  <files>js/security/message-security.js</files>
  <action>
Create js/security/message-security.js with the following implementation:

1. **Module structure:**
   - Create as ES6 module: `export const MessageSecurity = { ... }`
   - Use HMAC-SHA-256 algorithm for message signing
   - Implement nonce tracking for replay attack prevention
   - Follow patterns from StorageEncryption module

2. **signMessage(message, signingKey) method:**
   - Accept message object and CryptoKey from KeyManager.getSigningKey()
   - Create canonical message string by JSON.stringify(message) with sorted keys
   - Use TextEncoder to convert string to Uint8Array
   - Call crypto.subtle.sign('HMAC', signingKey, encodedMessage)
   - Return base64-encoded signature using btoa(String.fromCharCode(...signature))
   - Add timestamp to message if not present (using Date.now())
   - Include error handling with try/catch

3. **verifyMessage(message, signature, signingKey) method:**
   - Accept message object, signature string, and CryptoKey from KeyManager.getSigningKey()
   - Create canonical message string (same method as signMessage)
   - Use TextEncoder to convert string to Uint8Array
   - Decode signature from base64 to Uint8Array
   - Call crypto.subtle.verify('HMAC', signingKey, signature, encodedMessage)
   - Return true if signature valid, false otherwise
   - Include error handling that returns false on verification failure

4. **validateTimestamp(message, maxAgeSeconds) method:**
   - Accept message object and max age in seconds (default 5)
   - Check if message.timestamp exists
   - Calculate message age: (Date.now() - message.timestamp) / 1000
   - Return true if age <= maxAgeSeconds, false otherwise
   - Handle missing timestamp by returning false

5. **sanitizeMessage(message) method:**
   - Accept message object
   - Create deep copy to avoid modifying original
   - Remove sensitive fields: apiKey, token, secret, password, credentials
   - Recursively sanitize nested objects
   - Return sanitized message
   - Use pattern from Security.redactForLogging for reference

6. **Nonce tracking for replay prevention:**
   - Module-level Set to track used nonces: `const usedNonces = new Set()`
   - Maximum nonce cache size (1000 entries) to prevent memory issues
   - isNonceUsed(nonce): Check if nonce in Set
   - markNonceUsed(nonce): Add to Set, evict oldest if size > 1000
   - Nonce format: `${senderId}_${seq}_${timestamp}`

7. **Code quality:**
   - Add comprehensive JSDoc comments for all methods
   - Include parameter types and return types
   - Add usage examples in comments
   - Include security notes about replay attacks
   - Follow existing code style from storage-encryption.js
   - Use async/await throughout

Do NOT implement:
- Tab coordination integration - will be in Plan 02
- Message filtering - will be in Plan 02

Keep this module focused ONLY on core message security operations.
  </action>
  <verify>
1. File exists: ls -la js/security/message-security.js
2. Module exports MessageSecurity: grep "export const MessageSecurity" js/security/message-security.js
3. Contains signMessage method: grep "async signMessage" js/security/message-security.js
4. Contains verifyMessage method: grep "async verifyMessage" js/security/message-security.js
5. Contains validateTimestamp method: grep "validateTimestamp" js/security/message-security.js
6. Contains sanitizeMessage method: grep "sanitizeMessage" js/security/message-security.js
7. Contains nonce tracking methods: grep -E "(isNonceUsed|markNonceUsed)" js/security/message-security.js
8. Uses HMAC-SHA256: grep -i "HMAC" js/security/message-security.js
9. File has reasonable size (200+ lines): wc -l js/security/message-security.js
  </verify>
  <done>
MessageSecurity module created with HMAC-SHA256 sign/verify operations, timestamp validation, message sanitization, and nonce tracking for replay prevention, ready for integration with KeyManager and tab coordination.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate MessageSecurity into Security facade</name>
  <files>js/security/index.js</files>
  <action>
Update js/security/index.js to export MessageSecurity:

1. **Import MessageSecurity module:**
   - Add import at top of file: `import * as MessageSecurity from './message-security.js';`
   - Place after StorageEncryption import (around line 14)

2. **Export MessageSecurity through Security facade:**
   - Add to exports object (around line 470+): `MessageSecurity`
   - Place in logical grouping with other security modules after StorageEncryption
   - Add JSDoc comment explaining it provides HMAC-SHA256 message security

3. **Update KeyManager exports section JSDoc:**
   - Extend existing KeyManager documentation (around lines 410-446)
   - Add note that MessageSecurity uses KeyManager.getSigningKey()
   - Reference the integration pattern

4. **Maintain backward compatibility:**
   - Do NOT modify existing exports
   - Do NOT change existing API contracts
   - Only add new export, no breaking changes

5. **Code quality:**
   - Follow existing documentation style
   - Use consistent JSDoc format
   - Include usage guidance in comments
   - Reference StorageEncryption integration pattern

Reference pattern from existing StorageSecurity exports in lines 445-476.
  </action>
  <verify>
1. Import statement exists: grep "import.*message-security" js/security/index.js
2. Export exists: grep "MessageSecurity" js/security/index.js | grep -v "^import"
3. JSDoc documentation added: grep -B2 "MessageSecurity" js/security/index.js | grep -q "\/\*\*"
4. Module structure intact: node -c js/security/index.js (no syntax errors)
  </verify>
  <done>
MessageSecurity exported through Security facade, accessible via Security.MessageSecurity.signMessage(), Security.MessageSecurity.verifyMessage(), etc., ready for tab coordination integration.
  </done>
</task>

</tasks>

<verification>
After task completion, verify:
1. MessageSecurity module can be imported: node -e "import('./js/security/message-security.js').then(m => console.log('Module loaded:', !!m.MessageSecurity))"
2. Security facade exports MessageSecurity: In browser console, typeof Security.MessageSecurity === 'object'
3. Module has required methods: typeof Security.MessageSecurity.signMessage === 'function' && typeof Security.MessageSecurity.verifyMessage === 'function'
4. Module uses Web Crypto API patterns consistent with StorageEncryption
5. Nonce tracking methods present: typeof Security.MessageSecurity.isNonceUsed === 'function'
</verification>

<success_criteria>
1. MessageSecurity module created with HMAC-SHA256 sign/verify operations
2. Timestamp validation rejects messages older than 5 seconds
3. Message sanitization removes sensitive fields (apiKey, token, secret)
4. Nonce tracking prevents replay attacks with 1000-entry cache
5. Module exported through Security facade as Security.MessageSecurity
6. Module designed to use KeyManager.getSigningKey() (called by consumers)
7. Code follows existing patterns from storage-encryption.js and key-manager.js
8. Comprehensive JSDoc documentation included
</success_criteria>

<output>
After completion, create `.planning/phases/14-crosstab-security/14-01-SUMMARY.md`
</output>
