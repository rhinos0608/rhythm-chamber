---
phase: 09-key-foundation
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - js/security/index.js
autonomous: true

must_haves:
  truths:
    - KeyManager is exported through Security facade
    - Security.initializeKeySession() calls KeyManager.initializeSession()
    - Security.clearKeySession() calls KeyManager.clearSession()
    - Existing Security API remains unchanged (backward compatible)
  artifacts:
    - path: js/security/index.js
      provides: Unified security API with KeyManager integration
      exports: ["Security", "KeyManager", "initializeKeySession", "clearKeySession"]
  key_links:
    - from: Security.initializeKeySession
      to: KeyManager.initializeSession
      via: Direct method call
      pattern: "KeyManager\\.initializeSession"
    - from: app.js (future)
      to: Security.initializeKeySession
      via: Security facade
      pattern: "Security\\.initializeKeySession"
---

<objective>
Integrate KeyManager into the Security module facade.

Purpose: Make KeyManager accessible through the unified Security API, maintaining backward compatibility while adding new key management capabilities.
Output: Updated js/security/index.js that exports KeyManager functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/09-key-foundation/09-RESEARCH.md

@js/security/index.js
@.planning/phases/09-key-foundation/09-01-SUMMARY.md
@.planning/phases/09-key-foundation/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import KeyManager into security/index.js</name>
  <files>js/security/index.js</files>
  <action>
Add KeyManager import to js/security/index.js:

1. Add import after line 11 (after TokenBinding import):
```javascript
import * as KeyManager from './key-manager.js';
```

2. Add KeyManager to the Security object (around line 295, in the Security object definition):

Add under "// Key Management (NEW)" section or create new section:

```javascript
    // Key Management (NEW - Phase 9)
    KeyManager,
    initializeKeySession: KeyManager.initializeSession,
    clearKeySession: KeyManager.clearSession,
    isSecureContextKeyManager: KeyManager.isSecureContext,
    isKeySessionActive: KeyManager.isSessionActive,
```

3. Add to ES6 exports (around line 350):
```javascript
export {
    Security,
    ErrorContext,

    // Individual modules for direct import if needed
    Encryption,
    TokenBinding,
    Anomaly,
    KeyManager  // Add this
};
```

Note: Do NOT duplicate checkSecureContext - keep TokenBinding.checkSecureContext as the primary. The KeyManager.isSecureContext is an internal check, not for external use.
  </action>
  <verify>
  - import * as KeyManager from './key-manager.js' exists
  - KeyManager exported in Security object
  - initializeKeySession mapped to KeyManager.initializeSession
  - clearKeySession mapped to KeyManager.clearSession
  - KeyManager in ES6 export list
  - No duplicate exports (check exports don't overlap)
  </verify>
  <done>
Security facade now exports:
- Security.KeyManager (full module)
- Security.initializeKeySession(password)
- Security.clearKeySession()
- Security.isKeySessionActive()
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. Module loads without errors
2. Security.initializeKeySession is a function
3. Security.clearKeySession is a function
4. Security.KeyManager exists
5. KeyManager in ES6 exports
</verification>

<success_criteria>
1. KeyManager accessible via Security facade
2. Backward compatibility maintained (all existing Security.* exports work)
3. No console errors on module load
</success_criteria>

<output>
After completion, create `.planning/phases/09-key-foundation/09-03-SUMMARY.md`
</output>
