---
phase: 09-key-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/security/key-manager.js
autonomous: true

must_haves:
  truths:
    - KeyManager module creates non-extractable CryptoKey objects
    - Session keys are derived using PBKDF2 with 600,000 iterations
    - New session keys can be generated on browser session start
    - Session keys can be cleared from memory on logout
    - Secure context validation blocks crypto operations on non-HTTPS
  artifacts:
    - path: js/security/key-manager.js
      provides: Centralized key lifecycle management
      exports: ["initializeSession", "getSessionKey", "getDataEncryptionKey", "getSigningKey", "clearSession", "isSecureContext", "isSessionActive"]
      min_lines: 150
  key_links:
    - from: js/security/key-manager.js
      to: window.crypto.subtle
      via: Web Crypto API importKey/deriveKey
      pattern: "crypto\\.subtle\\.(importKey|deriveKey)"
    - from: initializeSession()
      to: _deriveKey()
      via: Internal key derivation
      pattern: "this\\._deriveKey\\("
---

<objective>
Create the KeyManager module with centralized key lifecycle management for non-extractable keys.

Purpose: Establish the foundation for secure key operations. All future crypto operations (storage encryption, message signing) will depend on this module.
Output: A new KeyManager module that creates, manages, and clears non-extractable CryptoKey objects.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/09-key-foundation/09-RESEARCH.md

@js/security/encryption.js
@js/security/token-binding.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KeyManager module with core API</name>
  <files>js/security/key-manager.js</files>
  <action>
Create new file `js/security/key-manager.js` with the following structure:

1. Module-scoped private state:
   - _sessionKey: CryptoKey | null
   - _dataEncryptionKey: CryptoKey | null
   - _signingKey: CryptoKey | null
   - _sessionActive: boolean
   - _sessionSalt: string | null

2. Public API methods:

   **initializeSession(password)**
   - Check isSecureContext() first, throw if false
   - Generate unique session salt via _generateSessionSalt()
   - Derive session key via _deriveKey(password, salt)
   - Derive data encryption key via _deriveDataEncryptionKey(password, salt)
   - Derive signing key via _deriveSigningKey(password, salt)
   - Set _sessionActive = true
   - Return true on success

   **getSessionKey()**
   - Throw if !_sessionActive or !_sessionKey
   - Return _sessionKey (non-extractable)

   **getDataEncryptionKey()**
   - Throw if !_sessionActive or !_dataEncryptionKey
   - Return _dataEncryptionKey (non-extractable)

   **getSigningKey()**
   - Throw if !_sessionActive or !_signingKey
   - Return _signingKey (non-extractable)

   **clearSession()**
   - Set all private keys to null
   - Set _sessionSalt to null
   - Set _sessionActive = false

   **isSecureContext()**
   - Check window.isSecureContext
   - Check for HTTPS protocol
   - Check for localhost/127.0.0.1 hostname
   - Return true if any condition passes

   **isSessionActive()**
   - Return _sessionActive

3. Private methods:

   **_generateSessionSalt()**
   - Use crypto.getRandomValues(new Uint8Array(32))
   - Convert to hex string
   - Return 64-character hex string

   **_deriveKey(password, salt)**
   - Use PBKDF2 with 600,000 iterations (OWASP 2024)
   - AES-GCM-256, 256-bit key
   - extractable: FALSE (KEY-01 requirement)
   - Key usage: ['encrypt', 'decrypt']

   **_deriveDataEncryptionKey(password, salt)**
   - Use PBKDF2 with password + ':data' modifier
   - Use salt + ':storage' modifier
   - Same parameters as _deriveKey
   - extractable: FALSE

   **_deriveSigningKey(password, salt)**
   - Use PBKDF2 with password + ':sign' modifier
   - Use salt + ':hmac' modifier
   - HMAC-SHA-256 algorithm
   - extractable: FALSE
   - Key usage: ['sign', 'verify']

4. Export the KeyManager object

IMPORTANT: All deriveKey/importKey calls MUST use extractable: false to satisfy KEY-01.

Follow the pattern from 09-RESEARCH.md lines 313-493, adapted to the existing codebase style.
  </action>
  <verify>
  - File exists at js/security/key-manager.js
  - All deriveKey/importKey calls have extractable: false
  - isSecureContext() checks HTTPS, localhost, 127.0.0.1
  - clearSession() nullifies all private state
  - Module exports KeyManager object
  </verify>
  <done>
KeyManager module exists with:
- initializeSession() creates 3 non-extractable keys
- getSessionKey(), getDataEncryptionKey(), getSigningKey() accessors
- clearSession() wipes all keys from memory
- isSecureContext() validates HTTPS/localhost
- isSessionActive() returns session state
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. Module syntax is valid (no import/export errors)
2. All crypto operations use extractable: false
3. isSecureContext() matches existing Security.checkSecureContext() behavior
4. Private methods use naming convention (_prefix)
</verification>

<success_criteria>
1. js/security/key-manager.js exists with all required methods
2. PBKDF2 uses 600,000 iterations (exceeds KEY-02 requirement)
3. All keys are non-extractable (satisfies KEY-01)
4. Session can be initialized and cleared
</success_criteria>

<output>
After completion, create `.planning/phases/09-key-foundation/09-01-SUMMARY.md`
</output>
