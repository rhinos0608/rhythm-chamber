---
phase: 09-key-foundation
plan: 04
type: execute
wave: 2
depends_on: ["09-01", "09-03"]
files_modified:
  - js/main.js
  - js/settings.js
autonomous: false
checkpoint_required: true

must_haves:
  truths:
    - KeyManager session is initialized during app bootstrap
    - KeyManager.clearSession() is called on logout
    - Secure context is validated before key operations
    - Session keys persist only in memory (not persisted to storage)
  artifacts:
    - path: js/main.js
      provides: App entry point with KeyManager initialization
      contains: "initializeKeySession"
    - path: js/settings.js
      provides: Settings UI with KeyManager cleanup on logout
      contains: "clearKeySession"
  key_links:
    - from: js/main.js bootstrap()
      to: Security.initializeKeySession
      via: Security facade
      pattern: "Security\\.initializeKeySession\\("
    - from: js/settings.js logout
      to: Security.clearKeySession
      via: Security facade
      pattern: "Security\\.clearKeySession\\("
---

<objective>
Integrate KeyManager into main.js bootstrap and settings.js logout flow.

Purpose: Complete the key lifecycle by initializing sessions on app startup and clearing keys on logout. This ensures keys are available for all crypto operations and properly cleaned up.
Output: Updated main.js with session initialization and settings.js with key cleanup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/09-key-foundation/09-RESEARCH.md

@js/main.js
@js/settings.js
@.planning/phases/09-key-foundation/09-01-SUMMARY.md
@.planning/phases/09-key-foundation/09-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KeyManager initialization to main.js bootstrap</name>
  <files>js/main.js</files>
  <action>
In js/main.js, add KeyManager session initialization to the bootstrap() function.

1. Find the bootstrap() function (starts at line 426)
2. Add key session initialization AFTER ConfigLoader.load() but BEFORE installing global error handlers

Insert after line 445 (after ConfigLoader.installWindowProxy()):

```javascript
        // Initialize KeyManager session for crypto operations
        // Uses Spotify refresh token as the password (if available)
        // If no token exists, use a session-based secret
        let keySessionInitialized = false;
        const keySessionPassword = localStorage.getItem('spotify_refresh_token') ||
                                    sessionStorage.getItem('rhythm_chamber_session_salt') ||
                                    'session-default';

        try {
            if (Security.initializeKeySession) {
                await Security.initializeKeySession(keySessionPassword);
                keySessionInitialized = true;
                console.log('[Main] KeyManager session initialized');
            }
        } catch (error) {
            console.warn('[Main] KeyManager initialization failed, continuing without key session:', error?.message || error);
            // Don't fail the entire app if KeyManager init fails
            // Crypto operations will fail gracefully with clear errors
        }
```

This placement ensures:
- KeyManager initializes after config is loaded
- Error is non-falling (app continues even if keys fail)
- Uses existing token as password source (compatible with current deriveKey pattern)
  </action>
  <verify>
  - KeyManager initialization added to bootstrap()
  - Runs after ConfigLoader.load()
  - Uses existing token as password source
  - Error is caught and logged (non-fatal)
  - Logs success/failure to console
  </verify>
  <done>
main.js bootstrap() now:
- Initializes KeyManager session on app startup
- Uses Spotify token or session secret as password
- Continues gracefully if initialization fails
  </done>
</task>

<task type="auto">
  <name>Task 2: Add KeyManager cleanup to settings.js logout</name>
  <files>js/settings.js</files>
  <action>
In js/settings.js, add KeyManager session cleanup to the existing logout/session reset flow.

1. Find the session reset function that calls Security.clearSessionData() (around line 1563)
2. Add Security.clearKeySession() call immediately after Security.clearSessionData()

Modify the existing code block (lines 1561-1567):

```javascript
    try {
        // Perform session invalidation
        if (Security.clearSessionData) {
            await Security.clearSessionData();
        } else if (Security.invalidateSessions) {
            Security.invalidateSessions();
        }

        // Clear KeyManager session keys from memory (KEY-05)
        if (Security.clearKeySession) {
            Security.clearKeySession();
            console.log('[Settings] KeyManager session cleared');
        }
```

This ensures:
- Key keys are wiped from memory on logout/session reset
- Runs after existing session cleanup
- Backward compatible (checks if method exists)
  </action>
  <verify>
  - Security.clearKeySession() called after clearSessionData()
  - Wrapped in existence check for backward compatibility
  - Console log confirms cleanup
  - Placed in session reset/logout flow
  </verify>
  <done>
settings.js now:
- Calls Security.clearKeySession() on logout/session reset
- Clears keys from memory (KEY-05 satisfied)
- Maintains backward compatibility
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete KeyManager integration:
- KeyManager session initializes on app bootstrap
- KeyManager session clears on logout
- All crypto operations use non-extractable keys
  </what-built>
  <how-to-verify>
1. Open browser DevTools Console
2. Load the app (refresh page if already open)
3. Check console for "[Main] KeyManager session initialized" message
4. In console, type: Security.isKeySessionActive()
5. Should return: true
6. Go to Settings > Advanced > Reset Session
7. Click "Reset Session" button
8. Check console for "[Settings] KeyManager session cleared"
9. In console, type: Security.isKeySessionActive()
10. Should return: false
11. Reload the page and verify session reinitializes
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After completion, verify:
1. App loads without errors
2. Console shows KeyManager initialization
3. Security.isKeySessionActive() returns true after load
4. Session reset clears keys (Security.isKeySessionActive() returns false)
5. Page reload reinitializes session
</verification>

<success_criteria>
1. KeyManager initializes on every app load (KEY-03 satisfied)
2. Keys clear on logout (KEY-05 satisfied)
3. App continues to work if KeyManager fails (graceful degradation)
4. No breaking changes to existing auth flow
</success_criteria>

<output>
After completion, create `.planning/phases/09-key-foundation/09-04-SUMMARY.md`
</output>
