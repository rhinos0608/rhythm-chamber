---
phase: 13-storage-encryption
plan: 03
type: execute
wave: 3
depends_on: [13-02]
files_modified:
  - js/security/storage-encryption.js
  - js/storage/config-api.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Existing plaintext API keys can be migrated to encrypted storage"
    - "Migration process preserves all existing data"
    - "Migration only processes unencrypted sensitive data"
    - "Already encrypted data is not re-encrypted"
    - "Migration failures are logged but don't block the process"
  artifacts:
    - path: "js/security/storage-encryption.js"
      provides: "Key rotation migration logic"
      contains: "migrateData"
      exports: ["migrateData"]
    - path: "js/storage/config-api.js"
      provides: "Migration orchestration"
      contains: "migrateToEncryptedStorage"
      exports: ["migrateToEncryptedStorage"]
  key_links:
    - from: "migrateToEncryptedStorage"
      to: "getAllConfig"
      via: "ConfigAPI"
      pattern: "getAllConfig"
    - from: "migrateToEncryptedStorage"
      to: "shouldEncrypt"
      via: "StorageEncryption"
      pattern: "shouldEncrypt"
    - from: "migrateToEncryptedStorage"
      to: "setConfig"
      via: "ConfigAPI"
      pattern: "setConfig"
    - from: "migrateData"
      to: "decrypt"
      via: "StorageEncryption"
      pattern: "decrypt.*oldKey"
    - from: "migrateData"
      to: "encrypt"
      via: "StorageEncryption"
      pattern: "encrypt.*newKey"
---

# Phase 13 Plan 03: Key Rotation and Migration

**Objective:** Implement key rotation migration logic to re-encrypt data when encryption keys change, and create migration function to convert existing plaintext API keys to encrypted storage.

Purpose: Enable secure key rotation by migrating encrypted data from old keys to new keys, and provide one-time migration to encrypt existing plaintext API keys that users may have in their databases.
Output: StorageEncryption.migrateData() for key rotation, ConfigAPI.migrateToEncryptedStorage() for initial migration.

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-storage-encryption/13-RESEARCH.md

# Prior Plans
@.planning/phases/13-storage-encryption/13-01-PLAN.md
@.planning/phases/13-storage-encryption/13-02-PLAN.md

# Existing Infrastructure
@js/storage/config-api.js
@js/storage/indexeddb.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement key rotation migration in StorageEncryption</name>
  <files>js/security/storage-encryption.js</files>
  <action>
Add key rotation migration logic to StorageEncryption module:

1. **Implement migrateData(oldKey, newKey, encryptedData) function:**
   - Export as standalone async function
   - Accept old CryptoKey, new CryptoKey, and encrypted data string
   - Decrypt data using oldKey: await decrypt(encryptedData, oldKey)
   - If decryption fails (returns null), return null immediately
   - Re-encrypt decrypted data using newKey: await encrypt(decrypted, newKey)
   - Return re-encrypted data
   - Include comprehensive error handling with try/catch
   - Log migration failures for debugging

2. **Add JSDoc documentation:**
   - Explain purpose: migrate encrypted data from old key to new key
   - Document parameters: oldKey, newKey, encryptedData
   - Document return: re-encrypted data or null on failure
   - Include usage example for key rotation scenario
   - Add security notes about key versioning

3. **Code quality:**
   - Follow existing error handling patterns from decrypt()
   - Include inline comments explaining each step
   - Use graceful degradation (return null on failure)
   - Log specific errors for debugging

Reference implementation from 13-RESEARCH.md lines 108-130.

Do NOT implement:
- Initial migration of existing plaintext data (Task 2)
- Secure deletion (Plan 04)
Keep focused on key rotation only.
  </action>
  <verify>
1. migrateData function exists: grep "function migrateData\|export.*migrateData" js/security/storage-encryption.js
2. Accepts oldKey parameter: grep "migrateData.*oldKey" js/security/storage-encryption.js
3. Accepts newKey parameter: grep "migrateData.*newKey" js/security/storage-encryption.js
4. Calls decrypt with oldKey: grep "decrypt.*oldKey" js/security/storage-encryption.js
5. Calls encrypt with newKey: grep "encrypt.*newKey" js/security/storage-encryption.js
6. Has error handling: grep -A3 "migrateData" js/security/storage-encryption.js | grep -E "try|catch"
  </verify>
  <done>
StorageEncryption.migrateData() can re-encrypt data from old key to new key for key rotation scenarios.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement initial migration function in ConfigAPI</name>
  <files>js/storage/config-api.js</files>
  <action>
Add migration function to convert existing plaintext sensitive data to encrypted storage:

1. **Implement migrateToEncryptedStorage() function:**
   - Export as async function in ConfigAPI
   - Get all existing config: await getAllConfig()
   - Iterate through Object.entries(allConfig)
   - For each [key, value]:
     * Check if shouldEncrypt(key, value)
     * Check if NOT already encrypted (value.encrypted !== true)
     * If both conditions true:
       - Log: console.log(`[Migration] Encrypting: ${key}`)
       - Re-store using setConfig(key, value) which will encrypt
     * If already encrypted or not sensitive: skip
   - Log completion: console.log('[Migration] All sensitive data encrypted')
   - Return count of migrated records

2. **Error handling:**
   - Wrap entire migration in try/catch
   - Continue processing on individual record failures
   - Log each record that fails to migrate
   - Return object with success/failure counts
   - Never block entire migration for single record failure

3. **Idempotency:**
   - Check existing encryption status before migrating
   - Skip records with value.encrypted === true
   - Safe to run multiple times without side effects
   - Only migrate plaintext sensitive data

4. **Code quality:**
   - Add JSDoc with usage example
   - Include progress logging
   - Follow existing ConfigAPI patterns
   - Add warning about one-time nature

Reference implementation from 13-RESEARCH.md lines 419-437.

Do NOT auto-run migration - it will be called manually or during app initialization.
  </action>
  <verify>
1. migrateToEncryptedStorage function exists: grep "function migrateToEncryptedStorage\|async migrateToEncryptedStorage" js/storage/config-api.js
2. Calls getAllConfig: grep "getAllConfig" js/storage/config-api.js | grep -v "export"
3. Calls shouldEncrypt: grep "shouldEncrypt" js/storage/config-api.js | wc -l (should be 3+ now)
4. Calls setConfig: grep -A5 "migrateToEncryptedStorage" js/storage/config-api.js | grep "setConfig"
5. Checks encrypted flag: grep -E "encrypted.*true|value\.encrypted" js/storage/config-api.js | wc -l (should increase)
6. Exported in ConfigAPI: grep "migrateToEncryptedStorage" js/storage/config-api.js | grep "export"
7. No syntax errors: node -c js/storage/config-api.js
  </verify>
  <done>
ConfigAPI.migrateToEncryptedStorage() can convert existing plaintext API keys and chat history to encrypted storage, checking for already-encrypted data to avoid re-encryption.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add migration trigger and documentation</name>
  <files>js/storage/config-api.js</files>
  <action>
Add migration trigger mechanism and documentation:

1. **Add MIGRATION_VERSION constant:**
   - Create constant at module level: `const MIGRATION_VERSION = 1;`
   - Add comment explaining version tracking for future migrations
   - Place near top of file with other constants

2. **Add migration tracking to setConfig:**
   - In encrypted data wrapper, add migrationVersion field
   - Set to MIGRATION_VERSION when encrypting
   - Used for future key rotation detection
   - Update metadata object structure:
     ```javascript
     valueToStore = {
       encrypted: true,
       keyVersion: 1,
       migrationVersion: MIGRATION_VERSION,
       value: encrypted
     }
     ```

3. **Update JSDoc documentation:**
   - Document migrateToEncryptedStorage() in ConfigAPI JSDoc
   - Add usage example: run after app initialization
   - Add note about checking existing encryption status
   - Include warning about backup recommendations

4. **Add console logging guidance:**
   - In migrateToEncryptedStorage, log start/end
   - Log count of records migrated
   - Log any records that failed to migrate
   - Include guidance for manual verification

5. **Code quality:**
   - Follow existing documentation style
   - Include clear usage instructions
   - Add troubleshooting notes
   - Reference future migration patterns

Do NOT auto-run migration - user/app must call it explicitly.
  </action>
  <verify>
1. MIGRATION_VERSION constant exists: grep "MIGRATION_VERSION" js/storage/config-api.js
2. migrationVersion field in encrypted wrapper: grep "migrationVersion" js/storage/config-api.js
3. Comprehensive JSDoc: grep -B10 "migrateToEncryptedStorage" js/storage/config-api.js | grep -E "\/\*\*|@example|@usage"
4. Exported in ConfigAPI object: grep "migrateToEncryptedStorage," js/storage/config-api.js
  </verify>
  <done>
Migration infrastructure complete with version tracking, documentation, and logging guidance for one-time migration of existing plaintext data.
  </done>
</task>

</tasks>

<verification>
After task completion, verify:
1. Key rotation works: migrateData() can decrypt with old key and re-encrypt with new key
2. Initial migration works: migrateToEncryptedStorage() converts plaintext to encrypted
3. Migration is idempotent: Running twice doesn't re-encrypt already-encrypted data
4. Migration tracking: Encrypted records include migrationVersion field
5. Error handling: Individual record failures don't stop entire migration
6. Documentation: Clear guidance on when/how to run migration
</verification>

<success_criteria>
1. StorageEncryption.migrateData() accepts oldKey, newKey, encryptedData
2. migrateData() decrypts with old key and re-encrypts with new key
3. migrateData() returns null on decryption failure
4. ConfigAPI.migrateToEncryptedStorage() iterates through all config
5. migrateToEncryptedStorage() checks shouldEncrypt() before migrating
6. migrateToEncryptedStorage() skips already-encrypted data
7. migrateToEncryptedStorage() uses setConfig() to trigger encryption
8. Encrypted data includes migrationVersion field
9. Migration has comprehensive JSDoc documentation
10. Migration is safe to run multiple times (idempotent)
</success_criteria>

<output>
After completion, create `.planning/phases/13-storage-encryption/13-03-SUMMARY.md`
</output>