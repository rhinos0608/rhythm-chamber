<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Chamber ‚Äî Analyze</title>
    <meta name="description"
        content="Upload your Spotify data and discover your music personality. Bring Your Own AI with Ollama, LM Studio, or OpenRouter.">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' blob: https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://accounts.spotify.com https://api.spotify.com https://openrouter.ai https://cdn.jsdelivr.net http://localhost:11434 http://localhost:1234 http://127.0.0.1:11434 http://127.0.0.1:1234; img-src 'self' data: https://i.scdn.co;">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;600;700&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"
        integrity="sha384-/TQbtLCAerC3jgaim+N78RZSDYV7ryeoBCVqTuzRrFec2akfBkHS7ACQ3PQhvMVi"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" title="Toggle sidebar">‚ò∞</button>
                <h1><a href="index.html">üéµ Rhythm Chamber</a></h1>
            </div>
            <div class="header-actions">
                <button class="settings-btn" id="settings-btn" onclick="Settings.showSettingsModal()"
                    title="Settings">‚öôÔ∏è</button>
                <button class="tools-btn" id="tools-btn" onclick="Settings.showToolsModal()"
                    title="AI Tools">üß∞</button>
                <button class="btn btn-secondary" id="privacy-dashboard-btn" onclick="showPrivacyDashboard()"
                    title="Privacy Dashboard">üîí</button>
                <button class="btn btn-secondary" id="reset-btn" style="display: none;">Start Over</button>
            </div>
        </header>

        <!-- App Layout with Sidebar -->
        <div class="app-layout" id="app-layout">
            <!-- Chat Sidebar -->
            <aside class="chat-sidebar" id="chat-sidebar">
                <div class="sidebar-header">
                    <button class="new-chat-btn" id="new-chat-btn">
                        <span>+</span> New Chat
                    </button>
                </div>
                <div class="sidebar-sessions" id="sidebar-sessions">
                    <!-- Dynamically populated with session items -->
                </div>
                <div class="sidebar-footer">
                    <button class="sidebar-collapse-btn" id="sidebar-collapse-btn" title="Hide sidebar">‚óÄ</button>
                </div>
            </aside>

            <!-- Sidebar Overlay for Mobile -->
            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <!-- Main Content -->
            <main class="app-main">
                <!-- Upload Zone -->
                <div class="upload-zone" id="upload-zone">
                    <div class="icon">üìÅ</div>
                    <h2>Drop your Spotify data here</h2>
                    <p>Upload a .zip export or .json streaming history. Your data stays on your device.</p>
                    <input type="file" id="file-input" accept=".zip,.json">
                    <button class="btn btn-primary" style="margin-top: var(--space-xl);"
                        onclick="document.getElementById('file-input').click()">
                        Choose File
                    </button>

                    <!-- Spotify Quick Snapshot Option -->
                    <div class="upload-alternatives">
                        <div class="divider-text">or get a quick snapshot</div>
                        <button class="btn btn-spotify" id="spotify-connect-btn">
                            <span>üéµ</span> Connect Spotify
                        </button>
                        <p style="margin-top: var(--space-sm); font-size: 0.8rem; color: var(--text-muted);">
                            Instant preview from your recent listening
                        </p>
                    </div>
                </div>

                <!-- Processing State -->
                <div class="processing" id="processing">
                    <div class="spinner"></div>
                    <p class="progress-text" id="progress-text">Reading your listening history...</p>
                </div>

                <!-- Personality Reveal (Full Data) -->
                <section class="reveal-section" id="reveal-section">
                    <div class="personality-reveal">
                        <div class="emoji" id="personality-emoji">üèõÔ∏è</div>
                        <h2 class="personality-type">Your Music Personality:</h2>
                        <h3 class="gradient-text" id="personality-name"
                            style="font-size: 2rem; margin-bottom: var(--space-lg);">The Emotional Archaeologist</h3>
                        <p class="personality-description" id="personality-description">
                            You don't just listen to music ‚Äî you use it to process feelings.
                            Your patterns show distinct "emotional eras."
                        </p>

                        <!-- Data Stats -->
                        <p class="data-stats" id="data-stats">
                            Analyzed <strong id="stream-count">0</strong> streams
                            from <span id="date-range-start">-</span> to <span id="date-range-end">-</span>
                        </p>

                        <div class="evidence-list" id="evidence-list">
                            <h4>Detected Patterns</h4>
                            <ul id="evidence-items">
                                <!-- Dynamically populated -->
                            </ul>
                        </div>

                        <!-- Detection Explainer -->
                        <details class="detection-explainer" id="detection-explainer">
                            <summary>How did we detect this?</summary>
                            <ul id="score-breakdown">
                                <!-- Dynamically populated -->
                            </ul>
                            <p class="score-total" id="score-total">Total: 0 points ‚Üí Type</p>
                        </details>

                        <div class="reveal-actions">
                            <button class="btn btn-primary" id="explore-chat-btn">
                                <span>üí¨</span> Explore in Chat
                            </button>
                            <button class="btn btn-secondary" id="share-card-btn">
                                <span>‚ÜóÔ∏è</span> Share Card
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Lite Reveal Section (Spotify API Data) -->
                <section class="lite-reveal-section" id="lite-reveal-section">
                    <div class="personality-reveal">
                        <div class="lite-badge">
                            <span>‚ö°</span> Quick Snapshot
                        </div>

                        <div class="emoji" id="lite-personality-emoji">üß≠</div>
                        <h2 class="personality-type">Your Current Vibe:</h2>
                        <h3 class="gradient-text" id="lite-personality-name"
                            style="font-size: 2rem; margin-bottom: var(--space-lg);">The Sound Explorer</h3>
                        <p class="personality-description" id="lite-personality-description">
                            Even your recent listens are diverse. You're constantly discovering and sampling new sounds.
                        </p>

                        <!-- Top Artists Display -->
                        <div class="genre-tags" id="lite-genre-tags">
                            <!-- Dynamically populated with genre tags -->
                        </div>

                        <div class="evidence-list" id="lite-evidence-list">
                            <h4>What We Found</h4>
                            <ul id="lite-evidence-items">
                                <!-- Dynamically populated -->
                            </ul>
                        </div>

                        <!-- Upsell Card -->
                        <div class="upsell-card">
                            <h4>‚ú® Want the full picture?</h4>
                            <p>Upload your complete Spotify history to discover your emotional eras, artists you've
                                stopped
                                listening to, life
                                events, and deeper patterns.</p>
                            <button class="btn btn-primary" id="lite-upload-full-btn">
                                <span>üìÅ</span> Upload Full History
                            </button>
                        </div>

                        <div class="reveal-actions" style="margin-top: var(--space-xl);">
                            <button class="btn btn-primary" id="lite-explore-chat-btn">
                                <span>üí¨</span> Explore in Chat
                            </button>
                            <button class="btn btn-secondary" id="lite-share-card-btn">
                                <span>‚ÜóÔ∏è</span> Share Card
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Chat Section -->
                <section class="chat-section" id="chat-section">
                    <div class="chat-header">
                        <p>üéµ You're <strong id="chat-personality-name">The Emotional Archaeologist</strong></p>
                    </div>

                    <div class="chat-messages" id="chat-messages">
                        <div class="message assistant">
                            What would you like to explore about your listening patterns?
                        </div>
                    </div>

                    <!-- Token Counter Display -->
                    <div class="token-counter" id="token-counter" style="display: none;">
                        <div class="token-info">
                            <span class="token-label">Tokens:</span>
                            <span class="token-count" id="token-count">0</span>
                            <span class="token-slash">/</span>
                            <span class="token-limit" id="token-limit">0</span>
                            <span class="token-percent" id="token-percent">(0%)</span>
                        </div>
                        <div class="token-bar">
                            <div class="token-bar-fill" id="token-bar-fill"></div>
                        </div>
                        <div class="token-warnings" id="token-warnings"></div>
                    </div>

                    <div class="chat-suggestions" id="chat-suggestions">
                        <button class="suggestion-chip" data-question="What was my music like in my data?">What was my
                            music
                            like in my data?</button>
                        <button class="suggestion-chip" data-question="Which artists did I stop listening to?">Which
                            artists
                            did I stop listening to?</button>
                        <button class="suggestion-chip" data-question="Which artist did I listen to the least?">Which
                            artist
                            did I listen to the least?</button>
                    </div>

                    <div class="chat-input-container">
                        <div class="chat-input-wrapper">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Ask about your music..."
                                autocomplete="off">
                            <button class="chat-send" id="chat-send">
                                <span>‚û§</span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Share Card Container -->
                <div class="share-card-container" id="share-card-container">
                    <div class="share-card" id="share-card">
                        <div class="emoji" id="card-emoji">üèõÔ∏è</div>
                        <h3>Your Music Personality</h3>
                        <p class="gradient-text" id="card-type-name"
                            style="font-size: 1.5rem; margin: var(--space-md) 0;">
                            The Emotional Archaeologist</p>
                        <p class="tagline" id="card-tagline">You mark time through sound.</p>
                        <p class="branding">rhythmchamber.com</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Reset Confirmation Modal -->
        <div class="modal-overlay" id="reset-confirm-modal" style="display: none;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <h3 style="margin-bottom: var(--space-md);">üîÑ Start Over?</h3>
                <p style="margin-bottom: var(--space-lg); color: var(--text-muted);">
                    Your data will be cleared. This cannot be undone.
                </p>
                <div style="display: flex; gap: var(--space-md); justify-content: center;">
                    <button class="btn btn-secondary" onclick="hideResetConfirmModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="executeReset()"
                        style="background: var(--danger, #dc3545);">
                        Yes, Start Over
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Chat Confirmation Modal -->
        <div class="modal-overlay" id="delete-chat-modal" style="display: none;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <h3 style="margin-bottom: var(--space-md);">üóëÔ∏è Delete Chat?</h3>
                <p style="margin-bottom: var(--space-lg); color: var(--text-muted);">
                    This conversation will be permanently deleted.
                </p>
                <div style="display: flex; gap: var(--space-md); justify-content: center;">
                    <button class="btn btn-secondary" onclick="hideDeleteChatModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmDeleteChat()"
                        style="background: var(--danger, #dc3545);">
                        Yes, Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Multi-Tab Warning Modal -->
        <div class="modal-overlay" id="multi-tab-modal" style="display: none;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <h3 style="margin-bottom: var(--space-md);">‚ö†Ô∏è Multiple Tabs Detected</h3>
                <p class="modal-message" style="margin-bottom: var(--space-lg); color: var(--text-muted);">
                    Rhythm Chamber is open in another tab. This tab is now read-only to prevent data corruption.
                </p>
                <div style="display: flex; gap: var(--space-md); justify-content: center;">
                    <button class="btn btn-primary"
                        onclick="document.getElementById('multi-tab-modal').style.display='none'">
                        OK, Continue in Read-Only Mode
                    </button>
                </div>
            </div>
        </div>

        <!-- Privacy Dashboard Modal -->
        <div class="modal-overlay" id="privacy-dashboard-modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; text-align: left;">
                <h3 style="margin-bottom: var(--space-md);">üîí Privacy Health Check</h3>
                <div class="privacy-dashboard" id="privacy-dashboard-content">
                    <p><strong>Raw streams:</strong> <span id="raw-streams-count">-</span></p>
                    <p><strong>Aggregated patterns:</strong> <span id="patterns-summary">-</span></p>
                    <div class="token-status" id="token-status">
                        <p><strong>Spotify Tokens:</strong> <span id="spotify-token-status">-</span></p>
                    </div>
                    <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-md); flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="clearSensitiveData()">Clear Raw Data</button>
                        <button class="btn btn-secondary"
                            onclick="document.getElementById('privacy-dashboard-modal').style.display='none'">Close</button>
                    </div>
                    <p style="margin-top: var(--space-md); font-size: 0.85rem; color: var(--text-muted);">
                        <small>All data is stored locally in your browser. Nothing is sent to any server.</small>
                    </p>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/security.js"></script>
    <script src="js/operation-lock.js"></script>
    <script src="js/state/app-state.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/payments.js"></script>
    <script src="js/rag.js"></script>
    <script src="js/local-vector-store.js"></script>
    <script src="js/local-embeddings.js"></script>
    <script src="js/spotify.js"></script>
    <script src="js/prompts.js"></script>
    <!-- Storage Modules -->
    <script src="js/storage/indexeddb.js"></script>
    <script src="js/storage/config-api.js"></script>
    <script src="js/storage/migration.js"></script>
    <script src="js/storage/sync-strategy.js"></script>
    <script src="js/storage/profiles.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/parser.js"></script>
    <script src="js/patterns.js"></script>
    <script src="js/personality.js"></script>
    <script src="js/genre-enrichment.js"></script>
    <script src="js/data-query.js"></script>
    <!-- Function Calling Modules (Modular Architecture) -->
    <script src="js/functions/utils/retry.js"></script>
    <script src="js/functions/utils/validation.js"></script>
    <script src="js/functions/schemas/data-queries.js"></script>
    <script src="js/functions/schemas/template-queries.js"></script>
    <script src="js/functions/schemas/analytics-queries.js"></script>
    <script src="js/functions/executors/data-executors.js"></script>
    <script src="js/functions/executors/template-executors.js"></script>
    <script src="js/functions/executors/analytics-executors.js"></script>
    <script src="js/functions/index.js"></script>
    <!-- Token Counter -->
    <script src="js/token-counter.js"></script>
    <!-- LLM Provider Modules -->
    <script src="js/providers/provider-interface.js"></script>
    <script src="js/providers/openrouter.js"></script>
    <script src="js/providers/lmstudio.js"></script>
    <script src="js/ollama.js"></script>
    <script src="js/providers/ollama-adapter.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/cards.js"></script>
    <!-- Services -->
    <script src="js/services/tab-coordination.js"></script>
    <script src="js/services/session-manager.js"></script>
    <script src="js/services/message-operations.js"></script>
    <!-- Controllers -->
    <script src="js/controllers/chat-ui-controller.js"></script>
    <script src="js/controllers/sidebar-controller.js"></script>
    <script src="js/controllers/view-controller.js"></script>
    <script src="js/controllers/file-upload-controller.js"></script>
    <script src="js/controllers/spotify-controller.js"></script>
    <script src="js/controllers/demo-controller.js"></script>
    <script src="js/controllers/reset-controller.js"></script>
    <script src="js/demo-data.js"></script>
    <!-- Template Profile System -->
    <script src="js/template-profiles.js"></script>
    <script src="js/profile-synthesizer.js"></script>
    <script src="js/app.js"></script>
</body>

</html>