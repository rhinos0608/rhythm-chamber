name: Architecture Validation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  architecture-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze dependencies
        run: npm run analyze:deps
        continue-on-error: true

      - name: Upload dependency graph
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph
          path: .state/dependency-graph.json
          retention-days: 30

      - name: Run architectural tests
        run: npm run test:architecture
        continue-on-error: true

      - name: Check for architectural violations
        run: |
          if [ -f .state/dependency-graph.json ]; then
            echo "Checking dependency graph..."
            node -e "
              const data = require('./.state/dependency-graph.json');
              const summary = data.summary;
              console.log('Circular dependencies:', summary.circularDependencies);
              console.log('Layer violations:', summary.layerViolations);

              if (summary.circularDependencies > 0 || summary.layerViolations > 50) {
                console.log('\\nâš ï¸ Architecture violations detected!');
                process.exit(1);
              } else {
                console.log('\\nâœ… Architecture validation passed!');
              }
            "
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('.state/dependency-graph.json')) {
              console.log('No dependency graph found');
              return;
            }

            const data = JSON.parse(fs.readFileSync('.state/dependency-graph.json', 'utf8'));
            const summary = data.summary;

            let comment = '## ðŸ” Architecture Validation Results\n\n';
            comment += `**Files analyzed:** ${summary.totalFiles}\n`;
            comment += `**Circular dependencies:** ${summary.circularDependencies}\n`;
            comment += `**Layer violations:** ${summary.layerViolations}\n\n`;

            if (summary.circularDependencies > 0) {
              comment += '### âš ï¸ Circular Dependencies\n\n';
              data.cycles.slice(0, 3).forEach((cycle, i) => {
                comment += `**Cycle ${i + 1}:**\n`;
                cycle.forEach(file => {
                  comment += `  â†’ \`${file}\`\n`;
                });
                comment += '\n';
              });
            }

            if (summary.layerViolations > 0) {
              comment += '### ðŸ“ Layer Violations\n\n';
              data.violations.slice(0, 10).forEach((v, i) => {
                comment += `${i + 1}. \`${v.file}\` imports \`${v.imports}\`\n`;
              });
              comment += `\n... and ${data.violations.length - 10} more\n`;
            }

            if (summary.circularDependencies === 0 && summary.layerViolations < 50) {
              comment += '### âœ… Overall Assessment\n\n';
              comment += 'Architecture validation passed! The codebase follows HNW principles.\n';
            } else {
              comment += '### âŒ Action Required\n\n';
              comment += 'Please fix the architectural violations before merging.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
