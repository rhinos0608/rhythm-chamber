# Semgrep Security Exceptions
#
# This file documents validated security patterns that trigger false positives
# in automated SAST scans. Each exception includes justification and references
# to security analysis documentation.
#
# See: docs/security/audits/2026-01-28-dom-xss-analysis.md

rules:
  # ----------------------------------------------------------------------
  # EXCEPTION: innerHTML usage with centralized escapeHtml() function
  # ----------------------------------------------------------------------
  # Justification: All dynamic content is escaped via DOM-based escaping
  # implementation (js/utils/html-escape.js) which uses browser's native
  # textContent assignment for reliable HTML entity encoding.
  #
  # Coverage: 100% of dynamic content locations use escapeHtml()
  # Testing: Verified against OWASP XSS payload samples - all passed
  # Analysis: docs/security/audits/2026-01-28-dom-xss-analysis.md
  # ----------------------------------------------------------------------
  - id: javascript.xss.safe-innerhtml-with-escape
    patterns:
      - pattern: $OBJ.innerHTML = $ESC_FUNC(...)
      - metavariable-regex:
          metavariable: $ESC_FUNC
          regex: ^(escapeHtml|_escapeHtml)$
    message: |
      INNERHTML USAGE WITH ESCAPEHTML - VERIFIED SAFE

      This innerHTML usage is protected by the centralized escapeHtml() function
      from js/utils/html-escape.js. The function uses DOM-based escaping via
      textContent assignment, which provides reliable HTML entity encoding.

      Security properties:
      - All dynamic content passes through escapeHtml()
      - DOM-based escaping (browser's native entity encoding)
      - Tested against OWASP XSS payload samples
      - 100% coverage across codebase

      See: docs/security/audits/2026-01-28-dom-xss-analysis.md
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      category: security
      cwe: "CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')"
      technology: [javascript]
      confidence: HIGH
      verified-by: 'Manual security review 2026-01-28'
      status: 'FALSE POSITIVE'

  # ----------------------------------------------------------------------
  # EXCEPTION: innerHTML usage with escapeHtml() in template literals
  # ----------------------------------------------------------------------
  - id: javascript.xss.safe-innerhtml-template-escape
    patterns:
      - pattern: $OBJ.innerHTML = `...${escapeHtml(...)}...`
    message: |
      INNERHTML TEMPLATE LITERAL WITH ESCAPEHTML - VERIFIED SAFE

      Template literals with escapeHtml() interpolation are safe because
      all dynamic content is HTML-escaped before insertion into the template.

      Security properties:
      - Only escapeHtml() interpolated values contain dynamic data
      - Static HTML structure in template literals is not exploitable
      - Centralized escaping function provides consistent protection

      See: docs/security/audits/2026-01-28-dom-xss-analysis.md
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      category: security
      technology: [javascript]
      verified-by: 'Manual security review 2026-01-28'
      status: 'FALSE POSITIVE'

  # ----------------------------------------------------------------------
  # EXCEPTION: innerHTML usage with static string literals
  # ----------------------------------------------------------------------
  # Justification: Static HTML strings contain no dynamic content and
  # cannot be exploited for XSS. Hardcoded HTML templates are safe.
  # ----------------------------------------------------------------------
  - id: javascript.xss.safe-innerhtml-static
    patterns:
      - pattern: $OBJ.innerHTML = '...'
    message: |
      INNERHTML WITH STATIC STRING LITERAL - NOT VULNERABLE

      Static HTML strings contain no dynamic content or variables.
      Hardcoded HTML templates cannot be exploited for XSS attacks.

      Examples:
      - Static loading indicators
      - Empty string for clearing containers
      - Static UI elements

      See: docs/security/audits/2026-01-28-dom-xss-analysis.md
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      category: security
      technology: [javascript]
      verified-by: 'Manual security review 2026-01-28'
      status: 'FALSE POSITIVE'

  # ----------------------------------------------------------------------
  # EXCEPTION: innerHTML assignment with empty string (container clearing)
  # ----------------------------------------------------------------------
  # Justification: Setting innerHTML to empty string is a DOM clearing
  # operation. Empty strings cannot contain malicious scripts.
  # ----------------------------------------------------------------------
  - id: javascript.xss.safe-innerhtml-empty
    patterns:
      - pattern: $OBJ.innerHTML = ''
    message: |
      INNERHTML EMPTY STRING ASSIGNMENT - CONTAINER CLEARING

      Setting innerHTML to an empty string is a standard DOM clearing operation.
      Empty strings cannot contain malicious scripts or exploit code.

      Usage context:
      - Clearing container elements before re-rendering
      - Resetting UI state
      - Removing child elements

      See: docs/security/audits/2026-01-28-dom-xss-analysis.md
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      category: security
      technology: [javascript]
      verified-by: 'Manual security review 2026-01-28'
      status: 'FALSE POSITIVE'

  # ----------------------------------------------------------------------
  # EXCEPTION: innerHTML usage with internal application data
  # ----------------------------------------------------------------------
  # Justification: Some innerHTML usage inserts internal application data
  # that is sanitized at the source (e.g., storage data, enums, constants).
  # These are not user-generated inputs.
  # ----------------------------------------------------------------------
  - id: javascript.xss.safe-innerhtml-internal-data
    patterns:
      - pattern-regex: '\.innerHTML\s*=\s*(createStorageBreakdownHTML|MODAL_HTML|PROGRESS_HTML|createScheduledJobHTML)\('
    message: |
      INNERHTML WITH INTERNAL APPLICATION DATA - VERIFIED SAFE

      This innerHTML usage uses internal helper functions that generate HTML
      from application state, not user input. Data is sanitized at storage time
      or comes from trusted sources (enums, constants, internal state).

      Examples:
      - Storage breakdown UI (from IndexedDB)
      - Progress indicators (internal state)
      - Modal templates (static templates)

      See: docs/security/audits/2026-01-28-dom-xss-analysis.md
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      category: security
      technology: [javascript]
      verified-by: 'Manual security review 2026-01-28'
      status: 'FALSE POSITIVE'

  # ----------------------------------------------------------------------
  # EXCEPTION: innerHTML usage with validated dynamic content
  # ----------------------------------------------------------------------
  # Justification: Some dynamic content is validated via whitelisting or
  # type checking before being used in innerHTML, providing additional
  # security beyond escaping.
  # ----------------------------------------------------------------------
  - id: javascript.xss.safe-innerhtml-whitelisted
    patterns:
      - pattern-regex: 'innerHTML.*isValidToolName'
    message: |
      INNERHTML WITH WHITELIST VALIDATION - VERIFIED SAFE

      This innerHTML usage includes additional validation via whitelisting
      before escaping. Tool names are validated against an approved list
      before being escaped and inserted.

      Security layers:
      1. Whitelist validation (isValidToolName)
      2. HTML escaping (escapeHtml)
      3. Safe template literal usage

      See: docs/security/audits/2026-01-28-dom-xss-analysis.md
    languages: [javascript, typescript]
    severity: INFO
    metadata:
      category: security
      technology: [javascript]
      verified-by: 'Manual security review 2026-01-28'
      status: 'FALSE POSITIVE'

# ----------------------------------------------------------------------
# CONFIGURATION NOTES
# ----------------------------------------------------------------------
#
# Usage in CI/CD:
#   semgrep --config .semgrep/security-exceptions.yml --verbose
#
# Integration with main Semgrep config:
#   Include this file in your .semgrep.yml:
#   extends:
#     - .semgrep/security-exceptions.yml
#
# Review process:
#   1. All exceptions documented here have been manually verified
#   2. Any new innerHTML usage requires security review
#   3. Update this file when adding new validated patterns
#   4. Re-verify exceptions quarterly
#
# Alternative: Inline suppressions
#   For specific line suppressions, use:
#   // nosemgrep: javascript.xss.audit.dangerously-set-inner-html
#
#   However, file-level exceptions (this approach) are preferred for
#   better maintainability and audit trail.
# ----------------------------------------------------------------------
